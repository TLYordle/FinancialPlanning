<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Plan System - Preview Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    .custom-field {
      @apply border border-gray-300 rounded-md p-2 bg-gray-200 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md;
    }
    .custom-button {
      @apply bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition duration-200 shadow-md;
    }
    .custom-link {
      @apply text-blue-600 hover:text-blue-800 underline;
    }
    .table-header {
      @apply bg-gray-200 text-gray-800 font-semibold;
    }
    .table-row {
      @apply border-b border-gray-300;
    }
  </style>
</head>
<body class="bg-gray-100">
<div class="bg-gray-300 p-4 flex justify-between items-center">
  <div class="flex items-center">
    <span class="text-lg font-bold">FINANCIAL PLAN SYSTEM</span>
  </div>
  <div class="flex items-center">
    <div class="text-right mr-2">
      <span id = "full_name" class="block">tranglth</span>
      <span id = "role"class="text-sm text-gray-600">Accounting depart</span>
    </div>
    <i class="fas fa-user ml-2"></i>
    <button onclick="logout()" class="bg-gray-500 text-white p-2 ml-4">Logout</button>
  </div>
</div>
<div class="bg-gray-400 p-2 flex justify-between items-center">
  <nav class="flex space-x-4">
    <a class="text-black homePage" href="../Admin/home_admin.html">Home</a>
    <a class="text-black" href="#">Financial plan</a>
    <a class="text-black font-bold" href="../Report/monthly_report_staff.html">Financial Report</a>
    <a class="text-black" href="../Term/listTerm.html">Term Management</a>
    <a class="text-black userPage" href="../Admin/list_user.html">User Management</a>
  </nav>
</div>
<!-- Main Content -->
<div class="bg-gray-100 flex justify-center min-h-screen">
  <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-7xl mt-6">
    <div class="mb-4">
      <h2 class="text-2xl font-semibold">Monthly Report</h2>
      <p class="text-blue-500">
        <a href="monthly_report_staff.html" class="custom-link underline">Report List</a> > Import Report
      </p>
    </div>
    <div class="max-w-7xl mx-auto mt-1 bg-gray-50 p-6 rounded shadow-md">
      <h3 class="text-lg font-medium mb-4">Step 2/2: Please preview the report details before submitting</h3>
      <div class="space-y-4">
        <div class="flex justify-stretch">
          <div class="flex items-center space-x-2">
            <p class="text-gray-700 text-base font-medium">Term:</p>
            <p id="termValue" class="text-gray-800 text-base">Q3-2022</p>
          </div>
          <div class="flex items-center space-x-2">
            <p class="text-gray-700 text-base font-medium">Department:</p>
            <p id="departmentValue" class="text-gray-800 text-base">HR</p>
          </div>
        </div>
        <div class="flex items-center space-x-2">
          <p class="text-gray-700 text-base font-medium">Month:</p>
          <p id="monthValue" class="text-gray-800 text-base">November</p>
        </div>
        <div class="flex items-center space-x-2">
          <p class="text-gray-700 text-base font-medium">File:</p>
          <p id="fileValue" class="text-gray-800 text-base"></p>
        </div>
      </div>


      <!-- Bảng hiển thị dữ liệu từ file -->
      <div class="overflow-auto max-h-96 border rounded-md mt-4">
        <table class="w-full border-collapse text-center bg-gray-100">
          <thead id="tableHead" class="table-header"></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="mt-6 flex justify-between">
        <button type="button" class="custom-button bg-blue-500 rounded p-2 text-white back-btn" onclick="goBack()">Back</button>
        <button type="submit" class="custom-button bg-green-500 rounded p-2 text-white submit-btn" onclick="submitReport()">Submit</button>
      </div>
    </div>
  </div>
</div>
<script>
  // Hàm logout
  function logout() {
      alert("Logged out successfully!");
  }

  // Hàm quay lại trang trước
  function goBack() {
      window.location.href = 'import_report.html';
  }

  // Hàm submit báo cáo
  function submitReport() {
    const reportData = {
        term: document.getElementById('termValue').textContent.trim(),
        month: document.getElementById('monthValue').textContent.trim(),
        department: document.getElementById('departmentValue').textContent.trim(),
        fileName: document.getElementById('fileValue').textContent.trim()
    };

    // Lấy dữ liệu từ bảng chi tiết
    const tableRows = document.querySelectorAll("#tableBody tr");
    let reportDetails = [];

    tableRows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length >= 9) { // Đảm bảo có đủ cột (Expense, Cost Type, Unit Price, Amount, Total, Project Name, Notes)
            const detail = {
                expense: cells[0].textContent.trim() === 'NULL' ? null : cells[0].textContent.trim(),
                costType: cells[1].textContent.trim() === 'NULL' ? null : cells[1].textContent.trim(),
                unitPrice: parseFloat(cells[2].textContent.replace(/,/g, '')) || 0, // Xóa dấu phẩy và parse thành số
                amount: parseInt(cells[4].textContent) || 0, // Giả sử cột Amount là cột thứ 5
                projectName: cells[6].textContent.trim() === 'NULL' ? null : cells[6].textContent.trim(),
                note: cells[7].textContent.trim() === 'NULL' ? null : cells[7].textContent.trim()
            };
            reportDetails.push(detail);
        }
    });

    // Tạo object để gửi lên server cho Monthly Report, sử dụng user_id
    const payload = {
        reportName: `Monthly Report - ${reportData.term} - ${reportData.month}`, // Tạo tên báo cáo
        termId: getTermIdFromName(reportData.term), // Hàm chuyển tên term sang termId
        monthName: reportData.month,
        user_id: localStorage.getItem('user_id'), // Sử dụng user_id thay vì userId
        department: reportData.department,
        status: "SUBMITTED", // Giả sử trạng thái mặc định là SUBMITTED
        reportDate: new Date().toISOString().split('T')[0], // Ngày hiện tại
        version: 1 // Version ban đầu
    };

    // Gửi dữ liệu tổng hợp (Monthly Report) lên server
    fetch('http://localhost:8080/api/reports/create', {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem('authToken')
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        const savedReportId = data.reportId; // Lấy reportId từ response

        // Gửi dữ liệu chi tiết (Monthly Report Details) lên server
        reportDetails.forEach(detail => {
            detail.reportId = savedReportId; // Gán reportId cho mỗi chi tiết
            // Tính lại total nếu cần (giả sử server sẽ xử lý)
            if (detail.unitPrice && detail.amount) {
                detail.total = detail.unitPrice * detail.amount; // Tính total đơn giản trong JS
            }
        });

        return fetch('http://localhost:8080/api/report_details/import', {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + localStorage.getItem('authToken')
            },
            body: JSON.stringify(reportDetails)
        });
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        alert("Báo cáo và chi tiết đã được lưu thành công!");
        window.location.href = 'monthly_report_staff.html'; // Chuyển hướng sau khi submit
    })
    .catch(error => {
        console.error("Lỗi khi lưu báo cáo:", error);
        alert("Có lỗi xảy ra khi lưu báo cáo: " + error.message);
    });
}

  // Hàm chuyển tên Term sang TermId (giả sử, dựa trên JSON thành công)
  function getTermIdFromName(termName) {
      // Logic để ánh xạ tên Term (ví dụ: "Q2 2024") sang TermId, dựa trên JSON thành công với termId = 2
      const terms = [
          { termId: 1, termName: "Q1 2024" },
          { termId: 2, termName: "Q2 2024" },
          { termId: 3, termName: "Q3 2024" },
          { termId: 4, termName: "Q4 2024" }
      ];
      const term = terms.find(t => t.termName === termName);
      return term ? term.termId : null;
  }

  // Xử lý sự kiện cho nút Back
  const backButton = document.querySelector('.back-btn');
  if (backButton) {
      backButton.addEventListener('click', function(event) {
          event.preventDefault(); // Ngăn form submit mặc định
          window.location.href = 'import_report.html';
      });
  }

  document.addEventListener('DOMContentLoaded', function() {
      const fileName = localStorage.getItem('importedFileName');
      if (fileName) document.getElementById('fileValue').textContent = fileName;

      const fileData = localStorage.getItem('excelData');
      if (fileData) {
          const jsonData = JSON.parse(fileData);
          renderTable(jsonData);
      }

      // Lấy giá trị từ localStorage và cập nhật theo dữ liệu trong ảnh
      const savedTerm = localStorage.getItem('selectedTerm') || 'N/A';
      const savedMonth = localStorage.getItem('selectedMonth') || 'N/A';

      // Hiển thị giá trị trong HTML
      document.getElementById('termValue').textContent = savedTerm;
      document.getElementById('monthValue').textContent = savedMonth;
      document.getElementById('departmentValue').textContent = 'HR';
      document.getElementById('fileValue').textContent = fileName;

      console.log('Loaded term from localStorage:', savedTerm);
      console.log('Loaded month from localStorage:', savedMonth);
  });

  function renderTable(data) {
      const tableHead = document.getElementById("tableHead");
      const tableBody = document.getElementById("tableBody");

      if (!data || data.length === 0) {
          tableHead.innerHTML = '';
          tableBody.innerHTML = '<tr><td colspan="9" class="p-2 text-gray-500">Không có dữ liệu trong file.</td></tr>';
          return;
      }

      // Tạo tiêu đề bảng
      const headers = Object.keys(data[0]);
      tableHead.innerHTML = "<tr>" + headers.map(col => `<th class="p-2 border bg-gray-300">${col}</th>`).join("") + "</tr>";

      // Tạo nội dung bảng, thay undefined hoặc trống bằng "NULL"
      tableBody.innerHTML = data.map(row =>
          `<tr class="table-row">` +
          headers.map((col, index) => {
              let value = row[col] === undefined || row[col] === '' ? 'NULL' : row[col];
              // Định dạng số cho cột 3 (Unit Price) và cột 5 (Total)
              if ((index === 2 || index === 4) && value !== 'NULL') {
                  value = Number(value).toLocaleString('en-US'); // Thêm dấu phẩy
              }
              return `<td class="p-2 border">${value}</td>`;
          }).join("") +
          `</tr>`
      ).join("");
  }

  async function fetchTerms(url = "http://localhost:8080/api/terms") {
      try {
          let userIdLocalStorage = localStorage.getItem("user_id");
          let userResponse = await fetch(`http://localhost:8080/api/users/${userIdLocalStorage}`);
          let user = await userResponse.json();
          let response = await fetch(url);
          let data = await response.json();
          return user.role;
      } catch (error) {
          console.error("Error fetching terms:", error);
      }
  }

  // Hàm tự chạy (Immediately Invoked Async Function Expression - IIFE)
  (async function() {
      let role = await fetchTerms();

      if (role !== 'ADMIN') {
          let homePage = document.querySelector('.homePage');
          let userPage = document.querySelector('.userPage');
          homePage.href = '../user/home.html';
          userPage.style.display = 'none';
      }
  })();

  var fullName = localStorage.getItem("full_name")
  var role = localStorage.getItem("role")
  var span = document.getElementById("full_name")
  var spanRole = document.getElementById("role")
  span.textContent = fullName
  spanRole.textContent = role
</script>
<script>
  var fullName = localStorage.getItem("full_name")
  var role = localStorage.getItem("role")
  var span = document.getElementById("full_name")
  var spanRole = document.getElementById("role")
  span.textContent = fullName
  spanRole.textContent = role
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      // Lấy giá trị từ localStorage
      const savedTerm = localStorage.getItem('selectedTerm');
      const savedMonth = localStorage.getItem('selectedMonth');

      // Hiển thị giá trị trong HTML
      if (savedTerm) {
          document.getElementById('termValue').textContent = savedTerm;
          console.log('Loaded term from localStorage:', savedTerm);
      } else {
          document.getElementById('termValue').textContent = 'Q2 2024'; // Mặc định từ ảnh
      }

      if (savedMonth) {
          document.getElementById('monthValue').textContent = savedMonth;
          console.log('Loaded month from localStorage:', savedMonth);
      } else {
          document.getElementById('monthValue').textContent = 'March'; // Mặc định từ ảnh
      }
  });
</script>
</body>
</html>