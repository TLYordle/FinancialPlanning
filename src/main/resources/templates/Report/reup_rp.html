<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Monthly Report Details - Financial Plan System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
<div class="bg-gray-300 p-4 flex justify-between items-center">
    <div class="flex items-center">
        <span class="text-lg font-bold">FINANCIAL PLAN SYSTEM</span>
    </div>
    <div class="flex items-center">
        <div class="text-right mr-2">
            <span id = "full_name" class="block">tranglth</span>
            <span id = "role"class="text-sm text-gray-600">Accounting depart</span>
        </div>
        <i class="fas fa-user ml-2"></i>
        <button onclick="logout()" class="bg-gray-500 text-white p-2 ml-4">Logout</button>
    </div>
</div>
<div class="bg-gray-400 p-2 flex justify-between items-center">
    <nav class="flex space-x-4">
        <a class="text-black homePage" href="../Admin/home_admin.html">Home</a>
        <a class="text-black" href="#">Financial plan</a>
        <a class="text-black font-bold" href="../Report/monthly_report_staff.html">Financial Report</a>
        <a class="text-black" href="../Term/listTerm.html">Term Management</a>
        <a class="text-black userPage" href="../Admin/list_user.html">User Management</a>
    </nav>
</div>
<div class="bg-gray-100 flex justify-center min-h-screen">
    <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-7xl mt-6">
        <div class="mb-4">
            <h2 class="text-2xl font-semibold">Monthly Report</h2>
            <p class="text-gray-500"><a href="monthly_report_staff.html" class="text-blue-500">Report List</a> > Report Details</p>
        </div>
        <div class="bg-gray-100 p-4 rounded-lg mb-6 flex justify-between">
            <div class="grid grid-cols-2 gap-6 w-full">
                <div class="flex-1 space-y-4">
                    <p><strong>Report:</strong> <span id="reportName"></span></p>
                    <p><strong>Term:</strong> <span id="term"></span></p>
                    <p><strong>Month:</strong> <span id="month"></span></p>
                    <p><strong>Department:</strong> <span id="department"></span></p>
                    <p><strong>Status:</strong> <span id="status"></span></p>
                </div>
                <div class="flex-1 space-y-4">
                    <p><strong>Uploaded by:</strong> <span id="uploadedBy"></span></p>
                    <p><strong>Report due date:</strong> <span id="dueDate"></span></p>
                    <p><strong>Date:</strong> <span id="date"></span></p>
                    <p><strong>Version:</strong> <span id="version"></span></p>
                </div>
            </div>
        </div>

        <div class="flex justify-end space-x-2 mb-4">
            <button class="bg-red-500 text-white p-2 rounded-md">Re-up</button>
        </div>
        <table id="reportDetailsTable" class="w-full border-collapse text-center bg-gray-50 rounded-lg shadow-lg overflow-hidden">
            <thead>
            <tr class="bg-gradient-to-r from-gray-200 to-gray-300">
                <th class="py-3 px-4 border-b font-semibold text-gray-700">No.</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Expense</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Cost Type</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Unit Price (VND)</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Amount</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Total (VND)</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Project Name</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Notes</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <button type="button" class="custom-button text-white bg-blue-500 p-2 rounded back-btn mt-4">Back</button>
    </div>
</div>

<script>
    // Hàm logout
    function logout() {
        alert("Đã đăng xuất thành công!");
        localStorage.removeItem('authToken');
        window.location.href = '../user/login.html'; // Chuyển hướng về trang login
    }


</script>
<script>
    // Hàm logout
    function logout() {
        alert("Đã đăng xuất thành công!");
        localStorage.removeItem('authToken');
        window.location.href = '../user/login.html'; // Chuyển hướng về trang login
    }

    var fullName = localStorage.getItem("full_name")
    var role = localStorage.getItem("role")
    var span = document.getElementById("full_name")
    var spanRole = document.getElementById("role")
    span.textContent = fullName
    spanRole.textContent = role

    let reportInfo = null; // Biến lưu trữ thông tin báo cáo tổng hợp

    document.addEventListener("DOMContentLoaded", function() {
        const backButton = document.querySelector(".back-btn");

        if (backButton) {
            backButton.addEventListener("click", function() {
                window.location.href = "monthly_report_staff.html";
            });
        }

        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('reportId');

        if (reportId) {
            fetchReportDetails(reportId);
            fetchReportInfo(reportId); // Load thông tin báo cáo tổng hợp
        } else {
            console.error("Không tìm thấy reportId trong URL");
            alert("Không có báo cáo được chọn. Vui lòng kiểm tra URL.");
        }

        // Sự kiện nhấn nút "Re-up"
        document.querySelector(".bg-red-500").addEventListener("click", function() {
            if (reportInfo) {
                displayReportInfo(reportInfo); // Giữ nguyên thông tin báo cáo
            }
            makeTableEditableAndSubmit(reportId); // Chỉnh sửa và tự động gửi dữ liệu
        });
    });

    // Hàm gọi API để lấy dữ liệu báo cáo chi tiết
    function fetchReportDetails(reportId) {
        fetch(`http://localhost:8080/api/report_details/${reportId}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + localStorage.getItem('authToken')
            },
        })
        .then((res) => res.json())
        .then((details) => {
            console.log("Dữ liệu chi tiết báo cáo:", details);
            displayReportDetailsTable(details);
        })
        .catch((error) => {
            console.error("Lỗi lấy dữ liệu chi tiết:", error);
            alert("Có lỗi xảy ra khi lấy dữ liệu báo cáo.");
        });
    }

    // Hàm gọi API để lấy dữ liệu báo cáo tổng hợp
    function fetchReportInfo(reportId) {
        fetch(`http://localhost:8080/api/reports/${reportId}`)
        .then((res) => res.json())
        .then((report) => {
            console.log("Dữ liệu báo cáo:", report);
            reportInfo = report; // Lưu thông tin báo cáo vào biến global
            displayReportInfo(report);
        })
        .catch((error) => {
            console.error("Lỗi khi lấy dữ liệu báo cáo:", error);
            alert("Có lỗi xảy ra khi lấy dữ liệu báo cáo.");
        });
    }

    // Hàm hiển thị dữ liệu báo cáo tổng hợp lên UI
    function displayReportInfo(report) {
        document.getElementById("reportName").innerText = report.reportName || "N/A";
        document.getElementById("term").innerText = report.term ? report.term.termName : "N/A";
        document.getElementById("month").innerText = report.monthName || "N/A";
        document.getElementById("department").innerText = report.user ? report.user.department : "N/A";
        document.getElementById("status").innerText = report.status || "N/A";
        document.getElementById("uploadedBy").innerText = report.user ? report.user.fullName : "N/A";
        document.getElementById("dueDate").innerText = report.term ? report.term.reportDueDate : "N/A";
        document.getElementById("date").innerText = report.reportDate || "N/A";
        document.getElementById("version").innerText = report.version || "N/A";
    }

    // Hiển thị dữ liệu chi tiết lên bảng
    function displayReportDetailsTable(details) {
        const tableBody = document.querySelector("#reportDetailsTable tbody");
        tableBody.innerHTML = "";

        details.forEach((detail, index) => {
            let detailId = detail.monthlyReportDetailsId; // Sử dụng monthlyReportDetailsId
            if (!detailId) {
                detailId = detail.id || detail.detailId || null;
                if (!detailId) {
                    console.warn("Không tìm thấy ID cho chi tiết:", detail);
                    alert("Dữ liệu chi tiết báo cáo thiếu ID, không thể hiển thị nút xóa!");
                    return;
                }
            }

            const row = document.createElement("tr");
            row.innerHTML = `
                <td class="py-2 px-4 border-b">${index + 1}</td>
                <td class="py-2 px-4 border-b"><input type="text" class="border p-1 w-full" value="${detail.expense || ""}"></td>
                <td class="py-2 px-4 border-b"><input type="text" class="border p-1 w-full" value="${detail.costType || ""}"></td>
                <td class="py-2 px-4 border-b"><input type="number" class="border p-1 w-full" value="${detail.unitPrice || 0}"></td>
                <td class="py-2 px-4 border-b"><input type="number" class="border p-1 w-full" value="${detail.amount || 0}"></td>
                <td class="py-2 px-4 border-b"><input type="number" class="border p-1 w-full" value="${detail.total || 0}"></td>
                <td class="py-2 px-4 border-b"><input type="text" class="border p-1 w-full" value="${detail.projectName || ""}"></td>
                <td class="py-2 px-4 border-b"><input type="text" class="border p-1 w-full" value="${detail.note || ""}"></td>
                <td class="py-2 px-4 border-b">
                    <button class="bg-red-500 text-white p-2 rounded-md delete-row" data-id="${detailId}">Xóa</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        document.querySelectorAll(".delete-row").forEach(button => {
            button.addEventListener("click", function() {
                const detailId = this.getAttribute("data-id");
                if (!detailId || detailId === "undefined" || detailId === "null") {
                    alert("ID chi tiết báo cáo không hợp lệ!");
                    console.error("Detail ID không hợp lệ:", detailId);
                    return;
                }
                deleteReportDetail(detailId, this);
            });
        });
    }

    // Hàm xóa một chi tiết báo cáo
    function deleteReportDetail(detailId, buttonElement) {
        if (!detailId) {
            alert("Không tìm thấy ID chi tiết báo cáo!");
            return;
        }

        if (!confirm(`Bạn có chắc chắn muốn xóa chi tiết báo cáo với ID ${detailId}? Hành động này không thể hoàn tác!`)) {
            return;
        }

        fetch(`http://localhost:8080/api/report_details/delete/${detailId}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + localStorage.getItem('authToken')
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            buttonElement.closest("tr").remove();
            alert("Đã xóa chi tiết báo cáo thành công!");
            updateTableRowNumbers();
        })
        .catch(error => {
            console.error("Lỗi khi xóa chi tiết báo cáo:", error);
            alert("Có lỗi xảy ra khi xóa chi tiết báo cáo: " + error.message);
        });
    }

    // Hàm cập nhật lại số thứ tự của các hàng trong bảng
    function updateTableRowNumbers() {
        const rows = document.querySelectorAll("#reportDetailsTable tbody tr");
        rows.forEach((row, index) => {
            row.cells[0].textContent = index + 1;
        });
    }

    // Hàm làm bảng có thể chỉnh sửa và tự động gửi dữ liệu
    function makeTableEditableAndSubmit(reportId) {
        const tableRows = document.querySelectorAll("#reportDetailsTable tbody tr");
        tableRows.forEach(row => {
            const cells = row.querySelectorAll("td:not(:first-child):not(:last-child)");
            cells.forEach(cell => {
                const value = cell.querySelector("input") ? cell.querySelector("input").value : cell.textContent.trim();
                if (cell.cellIndex === 3 || cell.cellIndex === 4 || cell.cellIndex === 5) { // Các cột số
                    cell.innerHTML = `<input type="number" class="border p-1 w-full" value="${parseFloat(value) || 0}">`;
                } else {
                    cell.innerHTML = `<input type="text" class="border p-1 w-full" value="${value === 'N/A' ? '' : value}">`;
                }
            });
        });

        // Tự động gửi dữ liệu sau khi chỉnh sửa
        submitReup(reportId);
    }

    // Gửi dữ liệu đã chỉnh sửa lên server
    function submitReup(reportId) {
        const tableRows = document.querySelectorAll("#reportDetailsTable tbody tr");
        let updatedData = [];

        tableRows.forEach(row => {
            const inputs = row.querySelectorAll("td input");

            let rowData = {
                monthlyReportDetailsId: row.querySelector(".delete-row")?.getAttribute("data-id"), // Lấy ID để cập nhật
                expense: inputs[0].value,
                costType: inputs[1].value,
                unitPrice: parseFloat(inputs[2].value) || 0,
                amount: parseInt(inputs[3].value) || 0,
                total: parseFloat(inputs[4].value) || 0,
                projectName: inputs[5].value,
                note: inputs[6].value
            };

            updatedData.push(rowData);
        });

        console.log("Dữ liệu cập nhật:", updatedData);

        fetch(`http://localhost:8080/api/report_details/update/${reportId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + localStorage.getItem('authToken')
            },
            body: JSON.stringify(updatedData)
        })
        .then(response => response.json())
        .then(data => {
            alert("Cập nhật thành công!");
            // Không cần reload, chỉ cập nhật lại bảng chi tiết
            fetchReportDetails(reportId); // Cập nhật lại bảng chi tiết sau khi submit
        })
        .catch(error => {
            console.error("Lỗi khi cập nhật:", error);
            alert("Có lỗi xảy ra khi cập nhật dữ liệu!");
        });
    }
</script>
</body>
</html>