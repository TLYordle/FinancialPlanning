<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Financial Plan System - Financial Monthly Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
</head>
<body>
<div class="bg-gray-300 p-4 flex justify-between items-center">
    <div class="flex items-center">
        <span class="text-lg font-bold">FINANCIAL PLAN SYSTEM</span>
    </div>
    <div class="flex items-center">
        <div class="text-right mr-2">
            <span id = "full_name" class="block">tranglth</span>
            <span id = "role"class="text-sm text-gray-600">Accounting depart</span>
        </div>
        <i class="fas fa-user ml-2"></i>
        <button onclick="logout()" class="bg-gray-500 text-white p-2 ml-4">Logout</button>
    </div>
</div>
<div class="bg-gray-400 p-2 flex justify-between items-center">
    <nav class="flex space-x-4">
        <a class="text-black homePage" href="../Admin/home_admin.html">Home</a>
        <a class="text-black" href="../FinancialPlan/Plan_list.html">Financial plan</a>
        <a class="text-black font-bold" href="#">Financial Report</a>
        <a class="text-black" href="../Term/listTerm.html">Term Management</a>
        <a class="text-black userPage" href="../Admin/list_user.html">User Management</a>
    </nav>
</div>
<div class="bg-gray-100 flex justify-center min-h-screen">
    <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-7xl mt-6">
        <div class="mb-4">
            <h2 class="text-2xl font-semibold">Monthly Report</h2>
            <p class="text-gray-500"><a href="#" class="text-blue-500">Report List</a></p>
        </div>
        <div class="flex space-x-2 mb-4">
            <button class="bg-green-500 text-white p-2 rounded-md import-btn" >Import</button>
        </div>

        <table id="reportTable" class="w-full border-collapse text-center bg-gray-50 rounded-lg shadow-lg overflow-hidden">
            <thead>
            <tr class="bg-gradient-to-r from-gray-200 to-gray-300">
                <th class="py-3 px-4 border-b font-semibold text-gray-700">No.</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Report</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Month</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Term</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Department</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Status</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Version</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Action</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

    </div>
</div>
<script src="../js/listRp.js"></script>
<script>
    function logout() {
        alert("Logged out successfully!");
    }

    function loadTerms() {
        fetch("http://localhost:8080/api/terms")
            .then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok " + response.statusText);
                }
                return response.json();
            })
            .then(terms => {
                const termSelect = document.getElementById("termSelect");
                termSelect.innerHTML = '<option value="">Term</option>';
                terms.forEach(term => {
                    const option = document.createElement("option");
                    option.value = term.termName; // hoặc sử dụng term.id nếu có
                    option.text = term.termName;
                    termSelect.appendChild(option);
                });
            })
            .catch(error => console.error("Error fetching terms:", error));
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadTerms();
    });



    // Hàm để xoá một dòng
    function deleteRow(rowNumber) {
        const table = document.getElementById('reportTable');
        const rows = table.getElementsByTagName('tr');

        // Tìm và xoá dòng có số tương ứng
        for (let i = 1; i < rows.length; i++) { // Bắt đầu từ 1 để bỏ qua header
            const rowData = rows[i].getElementsByTagName('td')[0].textContent;
            if (rowData === rowNumber.toString()) {
                rows[i].remove();
                updateRowNumbers();
                break;
            }
        }
    }

    // Hàm cập nhật lại số thứ tự các dòng sau khi xoá
    function updateRowNumbers() {
        const table = document.getElementById('reportTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) { // Bắt đầu từ 1 để bỏ qua header
            rows[i].getElementsByTagName('td')[0].textContent = i;
            // Cập nhật lại thuộc tính data-row cho nút xoá trong dòng này
            const deleteBtn = rows[i].querySelector('.text-red-500');
            if (deleteBtn) {
                deleteBtn.setAttribute('data-row', i);
            }
        }
    }

    // Thêm sự kiện cho các nút thùng rác (class text-red-500)
    document.addEventListener('DOMContentLoaded', function() {
        const deleteButtons = document.querySelectorAll('.text-red-500');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                const rowNumber = this.getAttribute('data-row');
                if (confirm('Bạn có chắc muốn xoá dòng này không?')) {
                    deleteRow(rowNumber);
                }
            });
        });

        const importButton = document.querySelector('.import-btn');
        if (importButton) {
            importButton.addEventListener('click', function() {
                window.location.href = 'import_report.html';
            });
        }
    });

    async function fetchTerms(url = "http://localhost:8080/api/terms") {
        try {
            let userIdLocalStorage = localStorage.getItem("user_id");
            let userResponse = await fetch(`http://localhost:8080/api/users/${userIdLocalStorage}`);
            let user = await userResponse.json();
            let response = await fetch(url);
            let data = await response.json();
            return user.role;
        } catch (error) {
            console.error("Error fetching report:", error);
        }
    }

    // Hàm tự chạy (Immediately Invoked Async Function Expression - IIFE)
    (async function() {
        let role = await fetchTerms();

        if (role !== 'ADMIN') {
            let homePage = document.querySelector('.homePage');
            let userPage = document.querySelector('.userPage');
            homePage.href = '../user/home.html';
            userPage.style.display = 'none';
        }
    })();
</script>
<script>
    var fullName = localStorage.getItem("full_name")
    var role = localStorage.getItem("role")
    var span = document.getElementById("full_name")
    var spanRole = document.getElementById("role")
    span.textContent = fullName
    spanRole.textContent = role
</script>
</body>
</html>
