<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Monthly Report Details - Financial Plan System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>

<body>
<div class="bg-gray-300 p-4 flex justify-between items-center">
    <div class="flex items-center">
        <span class="text-lg font-bold">FINANCIAL PLAN SYSTEM</span>
    </div>
    <div class="flex items-center">
        <div class="text-right mr-2">
            <span id = "full_name" class="block">tranglth</span>
            <span id = "role"class="text-sm text-gray-600">Accounting depart</span>
        </div>
        <i class="fas fa-user ml-2"></i>
        <button onclick="logout()" class="bg-gray-500 text-white p-2 ml-4">Logout</button>
    </div>
</div>
<div class="bg-gray-400 p-2 flex justify-between items-center">
    <nav class="flex space-x-4">
        <a class="text-black homePage" href="../Admin/home_admin.html">Home</a>
        <a class="text-black" href="#">Financial plan</a>
        <a class="text-black font-bold" href="../Report/monthly_report_staff.html">Financial Report</a>
        <a class="text-black" href="../Term/listTerm.html">Term Management</a>
        <a class="text-black userPage" href="../Admin/list_user.html">User Management</a>
    </nav>
</div>
<div class="bg-gray-100 flex justify-center min-h-screen">
    <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-7xl mt-6">
        <div class="mb-4">
            <h2 class="text-2xl font-semibold">Monthly Report</h2>
            <p class="text-gray-500"><a href="monthly_report_staff.html" class="text-blue-500">Report List</a> > Report Details</p>
        </div>
        <div class="bg-gray-100 p-4 rounded-lg mb-6 flex justify-between">
            <div class="grid grid-cols-2 gap-6 w-full">
                <div class="flex-1 space-y-4">
                    <p><strong>Report:</strong> <span id="reportName"></span></p>
                    <p><strong>Term:</strong> <span id="term"></span></p>
                    <p><strong>Month:</strong> <span id="month"></span></p>
                    <p><strong>Department:</strong> <span id="department"></span></p>
                    <p><strong>Status:</strong> <span id="status"></span></p>
                </div>
                <div class="flex-1 space-y-4">
                    <p><strong>Uploaded by:</strong> <span id="uploadedBy"></span></p>
                    <p><strong>Report due date:</strong> <span id="dueDate"></span></p>
                    <p><strong>Date:</strong> <span id="date"></span></p>
                    <p><strong>Version:</strong> <span id="version"></span></p>
                </div>
            </div>
        </div>
        <div class="bg-gray-100 p-4 rounded-lg mb-6 flex justify-between">
            <div class="flex-1">
                <p><strong>Total Expense = </strong> <span id="totalEx"></span></p>
            </div>
            <div class="flex-1 text-left">
                <p><strong>Biggest Expenditure = </strong> <span id="biggest"></span></p>
            </div>
        </div>

        <div class="flex justify-end space-x-2 mb-4">
            <button class="bg-gray-300 text-black p-2 rounded-md reup-btn">Re-up</button>
            <button class="bg-red-500 text-white p-2 rounded-md">Export</button>
        </div>
        <table id="reportDetailsTable" class="w-full border-collapse text-center bg-gray-50 rounded-lg shadow-lg overflow-hidden">
            <thead>
            <tr class="bg-gradient-to-r from-gray-200 to-gray-300">
                <th class="py-3 px-4 border-b font-semibold text-gray-700">No.</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Expense</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Cost Type</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Unit Price (VND)</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Amount</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Total (VND)</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Project Name</th>
                <th class="py-3 px-4 border-b font-semibold text-gray-700">Notes</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <button type="button" class="custom-button text-white bg-blue-500 p-2 rounded back-btn mt-4">Back</button>
    </div>
</div>

<script>
    // Hàm logout
    function logout() {
        alert("Đã đăng xuất thành công!");
        localStorage.removeItem('authToken');
        window.location.href = '../user/login.html'; // Chuyển hướng về trang login
    }
    document.addEventListener('DOMContentLoaded', function() {
  const reupButton = document.querySelector('.reup-btn');

  if (reupButton) {
    reupButton.addEventListener('click', function() {
      window.location.href = 'reup_rp.html';
    });
  }
});
    document.addEventListener("DOMContentLoaded", function () {
    // Lấy reportId từ URL
    const urlParams = new URLSearchParams(window.location.search);
    const reportId = urlParams.get('reportId');

    if (reportId) {
        fetchReportDetails(reportId);
    } else {
        console.error("Không tìm thấy reportId trong URL");
        alert("Không có báo cáo được chọn. Vui lòng kiểm tra URL.");
    }
});

// Hàm gọi API để lấy dữ liệu báo cáo chi tiết
function fetchReportDetails(reportId) {
    fetch(`http://localhost:8080/api/report_details/${reportId}`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + localStorage.getItem('authToken') // Nếu cần authentication
        },
    })
        .then((res) => res.json())
        .then((details) => {
            console.log("Dữ liệu chi tiết báo cáo:", details);
            displayReportDetailsTable(details);
        })
        .catch((error) => {
            console.error("Lỗi lấy dữ liệu chi tiết:", error);
            alert("Có lỗi xảy ra khi lấy dữ liệu báo cáo.");
        });
}

// Hàm hiển thị dữ liệu lên bảng trong HTML
function displayReportDetailsTable(details) {
    const tableBody = document.querySelector("#reportDetailsTable tbody");
    if (!tableBody) {
        console.error("Không tìm thấy tbody trong #reportDetailsTable");
        return;
    }
    tableBody.innerHTML = "";

    details.forEach((detail, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td class="py-2 px-4 border-b">${index + 1}</td>
            <td class="py-2 px-4 border-b">${detail.expense || "N/A"}</td>
            <td class="py-2 px-4 border-b">${detail.costType || "N/A"}</td>
            <td class="py-2 px-4 border-b">${detail.unitPrice ? detail.unitPrice.toLocaleString() : "0"} VND</td>
            <td class="py-2 px-4 border-b">${detail.amount || 0}</td>
            <td class="py-2 px-4 border-b">${detail.total ? detail.total.toLocaleString() : "0"} VND</td>
            <td class="py-2 px-4 border-b">${detail.projectName || "N/A"}</td>
            <td class="py-2 px-4 border-b">${detail.note || "N/A"}</td>
        `;
        tableBody.appendChild(row);
    });
}
document.addEventListener("DOMContentLoaded", function () {
    const urlParams = new URLSearchParams(window.location.search);
    const reportId = urlParams.get('reportId');

    if (reportId) {
        fetchReportInfo(reportId);
    } else {
        console.error("Không tìm thấy reportId trong URL");
        alert("Không có báo cáo được chọn. Vui lòng kiểm tra URL.");
    }
});

// Hàm gọi API để lấy dữ liệu báo cáo tổng hợp
function fetchReportInfo(reportId) {
    fetch(`http://localhost:8080/api/reports/${reportId}`)
        .then((res) => res.json())
        .then((report) => {
            console.log("Dữ liệu báo cáo:", report);
            displayReportInfo(report);
        })
        .catch((error) => {
            console.error("Lỗi khi lấy dữ liệu báo cáo:", error);
            alert("Có lỗi xảy ra khi lấy dữ liệu báo cáo.");
        });
}

// Hàm hiển thị dữ liệu lên UI
function displayReportInfo(report) {
    document.getElementById("reportName").innerText = report.reportName || "N/A";
    document.getElementById("term").innerText = report.term ? report.term.termName : "N/A";
    document.getElementById("month").innerText = report.monthName || "N/A";
    document.getElementById("department").innerText = report.user ? report.user.department : "N/A";
    document.getElementById("status").innerText = report.status || "N/A";
    document.getElementById("uploadedBy").innerText = report.user ? report.user.fullName : "N/A";
    document.getElementById("dueDate").innerText = report.term ? report.term.reportDueDate : "N/A";
    document.getElementById("date").innerText = report.reportDate || "N/A";
    document.getElementById("version").innerText = report.version || "N/A";
}

    function displayReportDetailsTable(details) {
    const tableBody = document.querySelector("#reportDetailsTable tbody");
    if (!tableBody) {
        console.error("Không tìm thấy tbody trong #reportDetailsTable");
        return;
    }
    tableBody.innerHTML = "";

    let totalExpense = 0;

    details.forEach((detail, index) => {
        const total = detail.total || 0;
        totalExpense += total; // Cộng tổng chi phí

        const row = document.createElement("tr");
        row.innerHTML = `
            <td class="py-2 px-4 border-b">${index + 1}</td>
            <td class="py-2 px-4 border-b">${detail.expense || "N/A"}</td>
            <td class="py-2 px-4 border-b">${detail.costType || "N/A"}</td>
            <td class="py-2 px-4 border-b">${detail.unitPrice ? detail.unitPrice.toLocaleString() : "0"} VND</td>
            <td class="py-2 px-4 border-b">${detail.amount || 0}</td>
            <td class="py-2 px-4 border-b">${total.toLocaleString()} VND</td>
            <td class="py-2 px-4 border-b">${detail.projectName || "N/A"}</td>
            <td class="py-2 px-4 border-b">${detail.note || "N/A"}</td>
        `;
        tableBody.appendChild(row);
    });
    document.getElementById("totalEx").innerText = totalExpense.toLocaleString() + " VND";
}
    function displayReportDetailsTable(details) {
    const tableBody = document.querySelector("#reportDetailsTable tbody");
    if (!tableBody) {
        console.error("Không tìm thấy tbody trong #reportDetailsTable");
        return;
    }
    tableBody.innerHTML = "";

    let totalExpense = 0;
    let maxExpenditure = 0;

    details.forEach((detail, index) => {
        const total = detail.total || 0;
        totalExpense += total; // Cộng tổng chi phí

        if (total > maxExpenditure) {
            maxExpenditure = total; // Cập nhật giá trị lớn nhất
        }

        const row = document.createElement("tr");
        row.innerHTML = `
            <td class="py-2 px-4 border-b">${index + 1}</td>
            <td class="py-2 px-4 border-b">${detail.expense || "N/A"}</td>
            <td class="py-2 px-4 border-b">${detail.costType || "N/A"}</td>
            <td class="py-2 px-4 border-b">${detail.unitPrice ? detail.unitPrice.toLocaleString() : "0"} VND</td>
            <td class="py-2 px-4 border-b">${detail.amount || 0}</td>
            <td class="py-2 px-4 border-b">${total.toLocaleString()} VND</td>
            <td class="py-2 px-4 border-b">${detail.projectName || "N/A"}</td>
            <td class="py-2 px-4 border-b">${detail.note || "N/A"}</td>
        `;
        tableBody.appendChild(row);
    });

    // Hiển thị tổng chi phí
    document.getElementById("totalEx").innerText = totalExpense.toLocaleString() + " VND";
    // Hiển thị khoản chi lớn nhất
    document.getElementById("biggest").innerText = maxExpenditure.toLocaleString() + " VND";
}


    document.addEventListener("DOMContentLoaded", function () {
    const exportButton = document.querySelector(".bg-red-500.text-white.p-2.rounded-md");

    if (exportButton) {
        exportButton.addEventListener("click", function () {
            exportTableToExcel();
        });
    }
});

    function exportTableToExcel() {
    let table = document.getElementById("reportDetailsTable");
    let ws = XLSX.utils.table_to_sheet(table); // Chuyển đổi bảng thành worksheet
    let wb = XLSX.utils.book_new();

    XLSX.utils.book_append_sheet(wb, ws, "Report Details");

    // Xuất file Excel với tên "Report_Details.xlsx"
    XLSX.writeFile(wb, "Report_Details.xlsx");
}


</script>
<script>
    var fullName = localStorage.getItem("full_name")
    var role = localStorage.getItem("role")
    var span = document.getElementById("full_name")
    var spanRole = document.getElementById("role")
    span.textContent = fullName
    spanRole.textContent = role
    document.addEventListener("DOMContentLoaded", function() {
    const backButton = document.querySelector(".back-btn");

    if (backButton) {
        backButton.addEventListener("click", function() {
            window.location.href = "monthly_report_staff.html";
        });
    }
});
    document.addEventListener("DOMContentLoaded", function () {
    const reupButton = document.querySelector(".bg-gray-300.text-black.p-2.rounded-md");

    if (reupButton) {
        reupButton.addEventListener("click", function () {
            // Lấy reportId từ URL
            const urlParams = new URLSearchParams(window.location.search);
            const reportId = urlParams.get('reportId');

            if (!reportId) {
                alert("Không tìm thấy reportId trong URL!");
                return;
            }

            // Lấy dữ liệu từ bảng
            const tableRows = document.querySelectorAll("#reportDetailsTable tbody tr");
            let reportData = [];

            tableRows.forEach(row => {
                const cells = row.querySelectorAll("td");
                let rowData = {
                    no: cells[0].innerText,
                    expense: cells[1].innerText,
                    costType: cells[2].innerText,
                    unitPrice: cells[3].innerText,
                    amount: cells[4].innerText,
                    total: cells[5].innerText,
                    projectName: cells[6].innerText,
                    notes: cells[7].innerText
                };
                reportData.push(rowData);
            });

            // Lưu dữ liệu vào localStorage
            localStorage.setItem("reupReportData", JSON.stringify(reportData));

            // Chuyển hướng đến trang reup_rp.html kèm theo reportId
            window.location.href = `reup_rp.html?reportId=${reportId}`;
        });
    }
});


</script>
</body>
</html>