<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Term</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<script src="../js/logout.js" type="text/javascript"></script>

<div class="bg-gray-300 p-4 flex justify-between items-center">
  <div class="flex items-center">
    <span class="text-lg font-bold">FINANCIAL PLAN SYSTEM</span>
  </div>
  <div class="flex items-center">
    <div class="text-right mr-2">
      <span id = "full_name" class="block">tranglth</span>
      <span id = "role"class="text-sm text-gray-600">Accounting depart</span>
    </div>
    <i class="fas fa-user ml-2"></i>
    <button onclick="logout()" class="bg-gray-500 text-white p-2 ml-4">Logout</button>
  </div>
</div>
<div class="bg-gray-400 p-2 flex justify-between items-center">
  <nav class="flex space-x-4">
    <a class="text-black" href="../home_admin.html">Home</a>
    <a class="text-black" href="#">Financial plan</a>
    <a class="text-black" href="../monthly_report_staff.html">Financial Report</a>
    <a class="text-black font-bold" href="listTerm.html">Term Management</a>
    <a class="text-black" href="../list_user.html">User Management</a>
  </nav>
</div>

<!--Body -->
  <div class="max-w-5xl mx-auto mt-10 p-6 bg-white shadow-lg rounded-lg">
    <h2 class="text-2xl font-bold mb-4">Term Management</h2>
    <nav class="text-gray-600 mb-6">
      <a href="listTerm.html" class="text-blue-600 underline">Term List</a> > <span class="text-gray-700">Edit term</span>
    </nav>

    <form id="editTermForm" class="grid grid-cols-2 gap-6">
      <div>
        <label class="block font-bold">Term name</label>
        <input type="text" id="termName" class="w-full p-2 border border-gray-300 rounded mt-1">
      </div>
      <div>
        <label class="block font-bold">Duration</label>
        <select id="duration" class="w-full p-2 border border-gray-300 rounded mt-1">
          <option value="MONTHLY">Monthly</option>
          <option value="QUARTERLY">Quarterly</option>
          <option value="HALFYEAR">Half Year</option>
        </select>
      </div>
      <div>
        <label class="block font-bold">Start date</label>
        <input type="date" id="startDate" class="w-full p-2 border border-gray-300 rounded mt-1">
      </div>
      <div>
        <label class="block font-bold">End date</label>
        <input type="date" id="endDate" class="w-full p-2 border border-gray-300 rounded mt-1">
      </div>
      <div>
        <label class="block font-bold">Plan due date</label>
        <input type="date" id="planDueDate" class="w-full p-2 border border-gray-300 rounded mt-1">
      </div>
      <div>
        <label class="block font-bold">Report due date</label>
        <input type="date" id="reportDueDate" class="w-full p-2 border border-gray-300 rounded mt-1">
      </div>
      <div>
        <label class="block font-bold">Status</label>
        <input type="text" id="status" class="w-full p-2 border border-gray-300 rounded mt-1" readonly>
      </div>
    </form>

    <div class="flex justify-between mt-6">
      <button onclick="goBack()" class="px-4 py-2 bg-gray-500 text-white rounded">Back</button>
      <div class="flex space-x-4">
        <button onclick="openConfirmModal()" class="px-4 py-2 bg-blue-500 text-white rounded">Start Term</button>
        <button onclick="submitEditTerm()" class="px-4 py-2 bg-green-600 text-white rounded">Submit</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-semibold text-center">Are you sure you want to start the term?</h3>
      <p class="text-center text-gray-600">This action cannot be reversed</p>
      <div class="flex justify-center space-x-6 mt-4">
        <button onclick="closeConfirmModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
        <button onclick="startTerm()" class="px-4 py-2 bg-red-600 text-white rounded">OK</button>
      </div>
    </div>
  </div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const termId = params.get("termId");

      fetch(`http://localhost:8080/api/terms/${termId}`)
          .then(response => response.json())
          .then(data => {
              document.getElementById("termName").value = data.termName;
              document.getElementById("duration").value = data.duration;
              document.getElementById("startDate").value = data.startDate;
              document.getElementById("endDate").value = data.endDate;
              document.getElementById("planDueDate").value = data.planDueDate;
              document.getElementById("reportDueDate").value = data.reportDueDate;
              document.getElementById("status").value = data.status;
          })
          .catch(error => console.error("Error loading term:", error));
  });

  function goBack() {
      window.location.href = "listTerm.html";
  }

  function submitEditTerm() {
      const params = new URLSearchParams(window.location.search);
      const termId = params.get("termId");

      const updatedTerm = {
          termName: document.getElementById("termName").value,
          duration: document.getElementById("duration").value,
          startDate: document.getElementById("startDate").value,
          endDate: document.getElementById("endDate").value,
          planDueDate: document.getElementById("planDueDate").value,
          reportDueDate: document.getElementById("reportDueDate").value,
          status: document.getElementById("status").value
      };

      fetch(`http://localhost:8080/api/terms/${termId}`, {
          method: "PUT",
          headers: {
              "Content-Type": "application/json"
          },
          body: JSON.stringify(updatedTerm)
      })
      .then(response => response.json())
      .then(data => {
          alert("Term updated successfully!");
          window.location.href = "viewTerm.html?termId=" + termId;
      })
      .catch(error => alert("This term name with status already exist!"));
  }

  function openConfirmModal() {
      document.getElementById("confirmModal").classList.remove("hidden");
  }

  function closeConfirmModal() {
      document.getElementById("confirmModal").classList.add("hidden");
  }

  function startTerm() {
      const params = new URLSearchParams(window.location.search);
      const termId = params.get("termId");

      fetch(`http://localhost:8080/api/terms/${termId}`)
          .then(response => response.json())
          .then(term => {
              let nextStatus = getNextStatus(term.status); // Xác định trạng thái tiếp theo

              if (!nextStatus) {
                  alert("Cannot update status. Already at the final stage.");
                  return;
              }

              fetch(`http://localhost:8080/api/terms/${termId}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ ...term, status: nextStatus })
              })
              .then(response => response.json())
              .then(updatedTerm => {
                  document.getElementById("status").value = updatedTerm.status;
                  alert(`Term status updated to: ${updatedTerm.status}`);
                  closeConfirmModal();
              })
              .catch(error => console.error("Error updating term:", error));
          })
          .catch(error => console.error("Error fetching term data:", error));
  }

  // Hàm xác định trạng thái tiếp theo
  function getNextStatus(currentStatus) {
      const statusFlow = ["NEW", "INPROGRESS", "CLOSED"];
      let currentIndex = statusFlow.indexOf(currentStatus);
      return currentIndex !== -1 && currentIndex < statusFlow.length - 1
          ? statusFlow[currentIndex + 1]
          : null;
  }
</script>
</body>
</html>
