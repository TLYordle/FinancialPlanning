<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Term Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
</head>
<body class="bg-gray-100">
<script src="../js/logout.js" type="text/javascript"></script>

<div class="bg-gray-300 p-4 flex justify-between items-center">
    <div class="flex items-center">
        <span class="text-lg font-bold">FINANCIAL PLAN SYSTEM</span>
    </div>
    <div class="flex items-center">
        <div class="text-right mr-2">
            <span id = "full_name" class="block">tranglth</span>
            <span id = "role"class="text-sm text-gray-600">Accounting depart</span>
        </div>
        <i class="fas fa-user ml-2"></i>
        <button onclick="logout()" class="bg-gray-500 text-white p-2 ml-4">Logout</button>
    </div>
</div>
<div class="bg-gray-400 p-2 flex justify-between items-center">
    <nav class="flex space-x-4">
        <a class="text-black homePage" href="../Admin/home_admin.html">Home</a>
        <a class="text-black" href="../FinancialPlan/Plan_list.html">Financial plan</a>
        <a class="text-black" href="../Report/monthly_report_staff.html">Financial Report</a>
        <a class="text-black font-bold" href="listTerm.html">Term Management</a>
        <a class="text-black userPage" href="../Admin/list_user.html">User Management</a>
    </nav>
</div>

<!-- Body -->
<div class="container mx-auto p-5">
    <div class="bg-white shadow-lg rounded-xl p-6">
        <h2 class="text-2xl font-bold mb-4">Term Management</h2>
        <div class="flex flex-wrap gap-4 mb-4 justify-center w-full">
            <input
                    type="text"
                    id="search"
                    class="border p-2 rounded w-80"
                    placeholder="Search"
            />
            <select id="statusFilter" class="border p-2 rounded w-48">
                <option value="ALL">ALL</option>
                <option value="NEW">NEW</option>
                <option value="INPROGRESS">INPROGRESS</option>
                <option value="CLOSED">CLOSED</option>
            </select>
            <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Search
            </button>
            <button class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                <a href="createTerm.html">Add</a>
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200">
                <thead class="bg-gray-800 text-white">
                <tr>
                    <th class="px-4 py-2 border">Term</th>
                    <th class="px-4 py-2 border">Start date</th>
                    <th class="px-4 py-2 border">End date</th>
                    <th class="px-4 py-2 border">Status</th>
                    <th class="px-4 py-2 border">Action</th>
                </tr>
                </thead>
                <tbody id="termTable" class="text-gray-700">
                <!-- Dữ liệu được chèn vào đây -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg">
        <h3 class="text-xl font-semibold text-center">Are you sure you want to delete the term?</h3>
        <p class="text-center text-gray-600">This action cannot be reversed</p>
        <div class="flex justify-center space-x-6 mt-4">
            <button onclick="closeConfirmModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Cancel</button>
            <button onclick="deleteTerm()" class="px-4 py-2 bg-red-600 text-white rounded">OK</button>
        </div>
    </div>
</div>

<script>
    async function fetchTerms(url = "http://localhost:8080/api/terms") {
        try {
            let userIdLocalStorage = localStorage.getItem("user_id");
            let userResponse = await fetch(`http://localhost:8080/api/users/${userIdLocalStorage}`);
            let user = await userResponse.json();
            let response = await fetch(url);
            let data = await response.json();
            renderTable(data, user.role, userIdLocalStorage);
            return user.role;
        } catch (error) {
            console.error("Error fetching terms:", error);
        }
    }

    // Hàm tự chạy (Immediately Invoked Async Function Expression - IIFE)
    (async function() {
        let role = await fetchTerms();

        if (role !== 'ADMIN') {
            let homePage = document.querySelector('.homePage');
            let userPage = document.querySelector('.userPage');
            homePage.href = '../home.html';
            userPage.style.display = 'none';
        }
    })();

    function renderTable(terms, role, userIdLocalStorage) {
        let tableBody = document.getElementById("termTable");
        tableBody.innerHTML = "";

        // Lọc các terms chưa bị xóa mềm
        let filteredTerms = terms.filter(term =>
            !term.deleted && term.createdBy.user_id === parseInt(userIdLocalStorage)
        );

        if (filteredTerms.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-2">No terms found</td></tr>`;
            return;
        }
        filteredTerms.forEach(term => {
            let actions = `
            <button class="text-blue-500 ml-2" onclick="viewTerm(${term.termId})">
                <i class="fas fa-eye"></i>
            </button>`;

            if (role !== "STAFF") {
                actions += `
                <button class="text-yellow-500 ml-2" onclick="editTerm(${term.termId})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="text-red-500 ml-2" onclick="openConfirmModal(${term.termId})">
                    <i class="fas fa-trash"></i>
                </button>`;
            }

            let row = `
            <tr class="border-t">
                <td class="px-4 py-2 border text-center">${term.termName}</td>
                <td class="px-4 py-2 border text-center">${new Date(term.startDate).toLocaleDateString()}</td>
                <td class="px-4 py-2 border text-center">${new Date(term.endDate).toLocaleDateString()}</td>
                <td class="px-4 py-2 border text-center">${term.status}</td>
                <td class="px-4 py-2 border space-x-2 text-center">${actions}</td>
            </tr>`;

            tableBody.innerHTML += row;
        });
    }

    function viewTerm(termId) {
        window.location.href = `viewTerm.html?termId=${termId}`;
    }

    function editTerm(termId) {
        window.location.href = `editTerm.html?termId=${termId}`;
    }

    async function searchTerms() {
        let searchValue = document.getElementById("search").value.trim();
        let statusValue = document.getElementById("statusFilter").value;
        let url;

        if (!searchValue) {
            url = `http://localhost:8080/api/terms/status/${encodeURIComponent(statusValue)}`;
        } else {
            url = `http://localhost:8080/api/terms/search?name=${encodeURIComponent(searchValue)}`;
            if (statusValue) url += `&status=${encodeURIComponent(statusValue)}`;
        }

        if (statusValue === "ALL") {
            fetchTerms();
        } else {
            fetchTerms(url);
        }
    }

    function openConfirmModal(termId) {
        let modal = document.getElementById("confirmModal");
        modal.classList.remove("hidden");
        modal.setAttribute("data-term-id", termId);
    }

    function closeConfirmModal() {
        document.getElementById("confirmModal").classList.add("hidden");
    }

    async function deleteTerm() {
        let termId = document.getElementById("confirmModal").getAttribute("data-term-id");

        if (!termId) {
            alert("Term ID not found!");
            return;
        }

        try {
            let response = await fetch(`http://localhost:8080/api/terms/${termId}`, { method: "DELETE" });

            if (!response.ok) throw new Error("Failed to delete term.");

            alert("Term deleted successfully!");
            closeConfirmModal();
            fetchTerms();
        } catch (error) {
            console.error("Error deleting term:", error);
        }
    }

    // Load terms khi trang được tải
    document.addEventListener("DOMContentLoaded", () => {
        fetchTerms();
        document.querySelector(".bg-blue-500").addEventListener("click", searchTerms);
    });

</script>
<script>
    var fullName = localStorage.getItem("full_name")
    var role = localStorage.getItem("role")
    var span = document.getElementById("full_name")
    var spanRole = document.getElementById("role")
    span.textContent = fullName
    spanRole.textContent = role
</script>
</body>
</html>
